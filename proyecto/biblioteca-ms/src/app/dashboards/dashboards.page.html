<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ 'dashboards.pageTitle' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="dashboards-page" [scrollY]="true" [fullscreen]="true">
  <!-- Estado de carga -->
  <ion-loading *ngIf="loading" [message]="'dashboards.loadingMessage' | translate" [showBackdrop]="true" [duration]="0"></ion-loading>

  <!-- Estado de error -->
  <ion-card *ngIf="!loading && error" color="danger">
    <ion-card-header>
      <ion-card-title>{{ 'dashboards.errorTitle' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>{{ error }}</ion-card-content>
  </ion-card>

  <!-- Estado vacío -->
  <ion-card *ngIf="!loading && !error && empty" color="warning">
    <ion-card-header>
      <ion-card-title>{{ 'dashboards.emptyTitle' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>{{ 'dashboards.emptyMessage' | translate }}</ion-card-content>
  </ion-card>

  <!-- Estado normal -->
  <ng-container *ngIf="!loading && !error && !empty">
    <ion-card class="dashboards-card">
      <ion-card-header class="dashboards-card-header">
        <ion-card-title>{{ 'dashboards.historicalMetrics' | translate }}</ion-card-title>
      </ion-card-header>
      <ion-card-content class="dashboards-card-content">
        <div class="metricas-flex">
          <div class="metrica-box">
            <div class="metrica-label">{{ 'dashboards.totalExams' | translate }}</div>
            <div class="metrica-valor">{{ totalExamenes }}</div>
            <div class="tendencia tendencia-positive">
              <ion-icon name="trending-up-outline"></ion-icon>
              <span>{{ 'dashboards.trendComparison' | translate:{ percent: tendenciaExamenes } }}</span>
            </div>
          </div>
          <div class="metrica-box">
            <div class="metrica-label">{{ 'dashboards.totalPeople' | translate }}</div>
            <div class="metrica-valor">{{ totalPersonas }}</div>
            <div class="tendencia tendencia-positive">
              <ion-icon name="trending-up-outline"></ion-icon>
              <span>{{ 'dashboards.trendComparison' | translate:{ percent: tendenciaPersonas } }}</span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card class="dashboards-card">
      <ion-card-header class="dashboards-card-header">
        <ion-card-title>{{ 'dashboards.examsByPeriod' | translate:{ period: periodLabel } }}
          <ion-select interface="popover" [(ngModel)]="periodo" class="periodo-select" (ionChange)="onPeriodoChange()">
            <ion-select-option value="semana">{{ 'dashboards.period.week' | translate }}</ion-select-option>
            <ion-select-option value="mes">{{ 'dashboards.period.month' | translate }}</ion-select-option>
            <ion-select-option value="anio">{{ 'dashboards.period.year' | translate }}</ion-select-option>
          </ion-select>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content class="dashboards-card-content">
  <ng-container *ngIf="chartData as chart">
          <ng-container *ngIf="chart.points.length > 0; else chartVacio">
            <div class="line-chart">
              <div class="line-chart-inner" [style.minWidth.px]="chart.width">
                <svg class="line-chart-svg"
                     [attr.viewBox]="'0 0 ' + chart.width + ' ' + chart.height"
                     [attr.width]="chart.width"
                     [attr.height]="chart.height"
                     preserveAspectRatio="none">
                  <g class="line-chart-guides">
                    <line *ngFor="let guide of chart.guides"
                          [attr.x1]="chart.padding.left"
                          [attr.x2]="chart.width - chart.padding.right"
                          [attr.y1]="guide.y"
                          [attr.y2]="guide.y"></line>
                  </g>
                  <polyline class="line-chart-path" [attr.points]="chart.polyline"></polyline>
                  <g class="line-chart-points">
                    <circle
                      *ngFor="let point of chart.points"
                      class="line-chart-point"
                      [class.active]="selectedPoint?.index === point.index"
                      [attr.cx]="point.x"
                      [attr.cy]="point.y"
                      r="6"
                      (click)="selectPoint(point)">
                      <title>{{ 'dashboards.chart.tooltip' | translate:{ label: point.label, value: point.value } }}</title>
                    </circle>
                  </g>
                </svg>
                <div class="line-chart-labels">
                  <span *ngFor="let point of chart.points">{{ point.label }}</span>
                </div>
              </div>
            </div>
            <div class="line-detail" *ngIf="selectedPoint">
              <h4>{{ selectedPoint.label }}</h4>
              <p>{{ 'dashboards.chart.detailTitle' | translate:{ value: selectedPoint.value } }}</p>
              <p class="line-detail-note">
                {{ periodo === 'anio' ? ('dashboards.chart.detailNote.year' | translate) : ('dashboards.chart.detailNote.day' | translate) }}
              </p>
            </div>
          </ng-container>
        </ng-container>
        <ng-template #chartVacio>
          <ion-text color="medium">{{ 'dashboards.chart.noData' | translate }}</ion-text>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- Lista simple para mostrar las consultas obtenidas -->
    <ion-card class="dashboards-card consultas-card">
      <ion-card-header class="dashboards-card-header">
        <ion-card-title>{{ consultasHeader }}</ion-card-title>
      </ion-card-header>
      <ion-card-content class="dashboards-card-content">
        <ion-list *ngIf="consultas.length > 0; else noConsultas">
          <ion-item *ngFor="let c of consultas; index as i">
            <ion-label>
              <h2>{{ 'cards.consultation.title' | translate }} #{{ c.idconsulta }}</h2>
              <p><strong>{{ 'exams.dateLabel' | translate }}:</strong> {{ c.fecha | date:'short' }}</p>
              <p *ngIf="c.motivo"><strong>{{ 'cards.consultation.motive' | translate }}:</strong> {{ c.motivo }}</p>
              <p *ngIf="c.duracionminutos"><strong>{{ 'cards.consultation.durationLabel' | translate }}:</strong> {{ 'cards.consultation.durationValue' | translate:{ minutes: c.duracionminutos } }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        <ng-template #noConsultas>
          <ion-text color="medium">{{ 'dashboards.consultationsEmpty' | translate }}</ion-text>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- Controles de paginación -->
    <ion-card *ngIf="totalPages > 1" class="dashboards-card pagination-card">
      <ion-card-content class="dashboards-card-content pagination-content">
        <ion-button 
          fill="clear" 
          [disabled]="!hasPreviousPage || loadingMore" 
          (click)="goToPreviousPage()"
          class="pagination-button">
          <span class="arrow-icon">←</span>
        </ion-button>
        
        <ion-text class="pagination-info">
          {{ 'dashboards.paginationInfo' | translate:{ current: currentPage, total: totalPages } }}
        </ion-text>
        
        <ion-button 
          fill="clear" 
          [disabled]="!hasNextPage || loadingMore" 
          (click)="goToNextPage()"
          class="pagination-button">
          <span class="arrow-icon">→</span>
        </ion-button>
      </ion-card-content>
    </ion-card>
  </ng-container>
</ion-content>