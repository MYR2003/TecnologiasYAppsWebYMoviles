<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ 'dashboards.pageTitle' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cerrarSesion()" shape="round" fill="solid" class="logout-button">
        <span class="logout-text">{{ 'profile.actions.logout' | translate }}</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="dashboards-page" [scrollY]="true" [fullscreen]="true">
  <!-- Estado de carga -->
  <ion-loading *ngIf="loading" [message]="'dashboards.loadingMessage' | translate" [showBackdrop]="true" [duration]="0"></ion-loading>

  <!-- Estado de error -->
  <ion-card *ngIf="!loading && error" color="danger">
    <ion-card-header>
      <ion-card-title>{{ 'dashboards.errorTitle' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>{{ error }}</ion-card-content>
  </ion-card>

  <!-- Estado vacío -->
  <ion-card *ngIf="!loading && !error && empty" color="warning">
    <ion-card-header>
      <ion-card-title>{{ 'dashboards.emptyTitle' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>{{ 'dashboards.emptyMessage' | translate }}</ion-card-content>
  </ion-card>

  <!-- Estado normal -->
  <ng-container *ngIf="!loading && !error && !empty">
    <!-- Grid de métricas principales -->
    <div class="metrics-grid">
      <ion-card class="metric-card metric-primary">
        <ion-card-content>
          <div class="metric-icon">
            <ion-icon name="people-outline"></ion-icon>
          </div>
          <div class="metric-info">
            <div class="metric-label">{{ 'dashboards.totalPatients' | translate }}</div>
            <div class="metric-value">{{ totalPersonas }}</div>
            <div class="metric-change positive">
              <ion-icon name="trending-up"></ion-icon>
              <span>+{{ tendenciaPersonas }}%</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="metric-card metric-success">
        <ion-card-content>
          <div class="metric-icon">
            <ion-icon name="medkit-outline"></ion-icon>
          </div>
          <div class="metric-info">
            <div class="metric-label">{{ 'dashboards.totalConsultations' | translate }}</div>
            <div class="metric-value">{{ totalConsultas }}</div>
            <div class="metric-change positive">
              <ion-icon name="trending-up"></ion-icon>
              <span>+8.5%</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="metric-card metric-warning">
        <ion-card-content>
          <div class="metric-icon">
            <ion-icon name="document-text-outline"></ion-icon>
          </div>
          <div class="metric-info">
            <div class="metric-label">{{ 'dashboards.totalExams' | translate }}</div>
            <div class="metric-value">{{ totalExamenes }}</div>
            <div class="metric-change positive">
              <ion-icon name="trending-up"></ion-icon>
              <span>+{{ tendenciaExamenes }}%</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="metric-card metric-info">
        <ion-card-content>
          <div class="metric-icon">
            <ion-icon name="time-outline"></ion-icon>
          </div>
          <div class="metric-info">
            <div class="metric-label">{{ 'dashboards.avgResponseTime' | translate }}</div>
            <div class="metric-value">2.4h</div>
            <div class="metric-change negative">
              <ion-icon name="trending-down"></ion-icon>
              <span>-3.2%</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Gráfico de tendencias -->
    <ion-card class="dashboards-card">
      <ion-card-header class="dashboards-card-header">
        <ion-card-title>{{ 'dashboards.examsByPeriod' | translate:{ period: periodLabel } }}
          <ion-select interface="popover" [(ngModel)]="periodo" class="periodo-select" (ionChange)="onPeriodoChange()">
            <ion-select-option value="semana">{{ 'dashboards.period.week' | translate }}</ion-select-option>
            <ion-select-option value="mes">{{ 'dashboards.period.month' | translate }}</ion-select-option>
            <ion-select-option value="anio">{{ 'dashboards.period.year' | translate }}</ion-select-option>
          </ion-select>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content class="dashboards-card-content">
  <ng-container *ngIf="chartData as chart">
          <ng-container *ngIf="chart.points.length > 0; else chartVacio">
            <div class="line-chart">
              <div class="line-chart-inner" [style.minWidth.px]="chart.width">
                <svg class="line-chart-svg"
                     [attr.viewBox]="'0 0 ' + chart.width + ' ' + chart.height"
                     [attr.width]="chart.width"
                     [attr.height]="chart.height"
                     preserveAspectRatio="none">
                  <g class="line-chart-guides">
                    <line *ngFor="let guide of chart.guides"
                          [attr.x1]="chart.padding.left"
                          [attr.x2]="chart.width - chart.padding.right"
                          [attr.y1]="guide.y"
                          [attr.y2]="guide.y"></line>
                  </g>
                  <polyline class="line-chart-path" [attr.points]="chart.polyline"></polyline>
                  <g class="line-chart-points">
                    <circle
                      *ngFor="let point of chart.points"
                      class="line-chart-point"
                      [class.active]="selectedPoint?.index === point.index"
                      [attr.cx]="point.x"
                      [attr.cy]="point.y"
                      r="6"
                      (click)="selectPoint(point)">
                      <title>{{ 'dashboards.chart.tooltip' | translate:{ label: point.label, value: point.value } }}</title>
                    </circle>
                  </g>
                </svg>
                <div class="line-chart-labels">
                  <span *ngFor="let point of chart.points">{{ point.label }}</span>
                </div>
              </div>
            </div>
            <div class="line-detail" *ngIf="selectedPoint">
              <h4>{{ selectedPoint.label }}</h4>
              <p>{{ 'dashboards.chart.detailTitle' | translate:{ value: selectedPoint.value } }}</p>
              <p class="line-detail-note">
                {{ periodo === 'anio' ? ('dashboards.chart.detailNote.year' | translate) : ('dashboards.chart.detailNote.day' | translate) }}
              </p>
            </div>
          </ng-container>
        </ng-container>
        <ng-template #chartVacio>
          <ion-text color="medium">{{ 'dashboards.chart.noData' | translate }}</ion-text>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- Grid de estadísticas adicionales -->
    <div class="stats-grid">
      <!-- Distribución por especialidades -->
      <ion-card class="stats-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="pulse-outline"></ion-icon>
            {{ 'dashboards.specialties' | translate }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="progress-list">
            <div class="progress-item">
              <div class="progress-label">
                <span>Cardiología</span>
                <span class="progress-value">245</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 85%"></div>
              </div>
            </div>
            <div class="progress-item">
              <div class="progress-label">
                <span>Pediatría</span>
                <span class="progress-value">198</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 68%"></div>
              </div>
            </div>
            <div class="progress-item">
              <div class="progress-label">
                <span>Traumatología</span>
                <span class="progress-value">156</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 54%"></div>
              </div>
            </div>
            <div class="progress-item">
              <div class="progress-label">
                <span>Medicina General</span>
                <span class="progress-value">289</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Alertas y notificaciones -->
      <ion-card class="stats-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="notifications-outline"></ion-icon>
            {{ 'dashboards.recentAlerts' | translate }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="alert-list">
            <div class="alert-item alert-warning">
              <ion-icon name="warning-outline"></ion-icon>
              <div class="alert-content">
                <div class="alert-title">Exámenes pendientes</div>
                <div class="alert-desc">15 exámenes sin revisar</div>
              </div>
            </div>
            <div class="alert-item alert-info">
              <ion-icon name="information-circle-outline"></ion-icon>
              <div class="alert-content">
                <div class="alert-title">Consultas del día</div>
                <div class="alert-desc">23 consultas programadas</div>
              </div>
            </div>
            <div class="alert-item alert-success">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <div class="alert-content">
                <div class="alert-title">Fichas actualizadas</div>
                <div class="alert-desc">+12 fichas completadas hoy</div>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Métricas de rendimiento -->
    <div class="performance-grid">
      <ion-card class="performance-card">
        <ion-card-content>
          <div class="circular-progress">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" class="progress-bg"></circle>
              <circle cx="50" cy="50" r="45" class="progress-circle" [style.stroke-dashoffset]="282 - (282 * 0.72)"></circle>
            </svg>
            <div class="progress-text">
              <span class="progress-percent">72%</span>
              <span class="progress-label">Satisfacción</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="performance-card">
        <ion-card-content>
          <div class="circular-progress">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" class="progress-bg"></circle>
              <circle cx="50" cy="50" r="45" class="progress-circle" [style.stroke-dashoffset]="282 - (282 * 0.89)"></circle>
            </svg>
            <div class="progress-text">
              <span class="progress-percent">89%</span>
              <span class="progress-label">Atención</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="performance-card">
        <ion-card-content>
          <div class="circular-progress">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" class="progress-bg"></circle>
              <circle cx="50" cy="50" r="45" class="progress-circle" [style.stroke-dashoffset]="282 - (282 * 0.65)"></circle>
            </svg>
            <div class="progress-text">
              <span class="progress-percent">65%</span>
              <span class="progress-label">Eficiencia</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

  </ng-container>
</ion-content>