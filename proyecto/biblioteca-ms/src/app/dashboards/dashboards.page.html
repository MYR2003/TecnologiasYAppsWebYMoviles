<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Dashboards</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="dashboards-page">
  <!-- Estado de carga -->
  <ion-loading *ngIf="loading" message="Cargando métricas..." [showBackdrop]="true" [duration]="0"></ion-loading>

  <!-- Estado de error -->
  <ion-card *ngIf="!loading && error" color="danger">
    <ion-card-header>
      <ion-card-title>Error</ion-card-title>
    </ion-card-header>
    <ion-card-content>{{ error }}</ion-card-content>
  </ion-card>

  <!-- Estado vacío -->
  <ion-card *ngIf="!loading && !error && empty" color="warning">
    <ion-card-header>
      <ion-card-title>Sin datos</ion-card-title>
    </ion-card-header>
    <ion-card-content>No hay métricas disponibles.</ion-card-content>
  </ion-card>

  <!-- Estado normal -->
  <ng-container *ngIf="!loading && !error && !empty">
    <ion-card class="dashboards-card">
      <ion-card-header class="dashboards-card-header">
        <ion-card-title>Métricas históricas</ion-card-title>
      </ion-card-header>
      <ion-card-content class="dashboards-card-content">
        <div class="metricas-flex">
          <div class="metrica-box">
            <div class="metrica-label">Total exámenes</div>
            <div class="metrica-valor">
              {{ totalExamenes }}
              <span class="tendencia" [ngClass]="{'up': tendenciaExamenes > 0, 'down': tendenciaExamenes < 0}">
                <ion-icon *ngIf="tendenciaExamenes > 0" name="arrow-up-outline"></ion-icon>
                <ion-icon *ngIf="tendenciaExamenes < 0" name="arrow-down-outline"></ion-icon>
                <span *ngIf="tendenciaExamenes !== 0"
                  [ngClass]="tendenciaExamenes > 0 ? 'tendencia-green' : (tendenciaExamenes < 0 ? 'tendencia-red' : '')">
                  {{ tendenciaExamenes > 0 ? '+' : '' }}{{ tendenciaExamenes }}% respecto a la semana anterior
                </span>
              </span>
            </div>
            <div class="sparkline-container">
              <svg *ngIf="exPorDia.length > 1" [attr.width]="120" [attr.height]="24" class="sparkline">
                <polyline [attr.points]="getSparklinePoints(exPorDia, 120, 24)" fill="none" stroke="#2563eb"
                  stroke-width="2" />
              </svg>
            </div>
          </div>
          <div class="metrica-box">
            <div class="metrica-label">Total personas</div>
            <div class="metrica-valor">
              {{ totalPersonas }}
              <span class="tendencia" [ngClass]="{'up': tendenciaPersonas > 0, 'down': tendenciaPersonas < 0}">
                <ion-icon *ngIf="tendenciaPersonas > 0" name="arrow-up-outline"></ion-icon>
                <ion-icon *ngIf="tendenciaPersonas < 0" name="arrow-down-outline"></ion-icon>
                <span *ngIf="tendenciaPersonas !== 0"
                  [ngClass]="tendenciaPersonas > 0 ? 'tendencia-green' : (tendenciaPersonas < 0 ? 'tendencia-red' : '')">
                  {{ tendenciaPersonas > 0 ? '+' : '' }}{{ tendenciaPersonas }}% respecto a la semana anterior
                </span>
              </span>
            </div>
            <div class="sparkline-placeholder"> <!-- Aquí iría el sparkline --> </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card class="dashboards-card">
      <ion-card-header class="dashboards-card-header">
        <ion-card-title>Exámenes {{ periodLabel }}
          <ion-select interface="popover" [(ngModel)]="periodo" class="periodo-select">
            <ion-select-option value="semana">Semana</ion-select-option>
            <ion-select-option value="mes">Mes</ion-select-option>
            <ion-select-option value="anio">Año</ion-select-option>
          </ion-select>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content class="dashboards-card-content">
        <div class="bar-chart">
          <div *ngFor="let val of exPorDia; let i = index" class="bar-group">
            <div class="bar-tooltip">
              <div class="bar-valor">{{ val }}</div>
              <div class="bar" [ngStyle]="{height: ((val / (maxValue || 1)) * 100) + '%'}"
                [attr.title]="labels[i] + ': ' + val"></div>
            </div>
            <span class="bar-label">{{ labels[i] }}</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Lista simple para mostrar las consultas obtenidas -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Consultas ({{ totalConsultas > 0 ? ((currentPage - 1) * pageSize + 1) + '-' + ((currentPage - 1) * pageSize + consultas.length) + ' de ' + totalConsultas : '0' }})</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="consultas.length > 0; else noConsultas">
          <ion-item *ngFor="let c of consultas; index as i">
            <ion-label>
              <h2>Consulta #{{ c.idconsulta }}</h2>
              <p><strong>Fecha:</strong> {{ c.fecha | date:'short' }}</p>
              <p *ngIf="c.motivo"><strong>Motivo:</strong> {{ c.motivo }}</p>
              <p *ngIf="c.duracionminutos"><strong>Duración:</strong> {{ c.duracionminutos }} min</p>
            </ion-label>
          </ion-item>
        </ion-list>
        <ng-template #noConsultas>
          <ion-text color="medium">No hay consultas para mostrar.</ion-text>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- Controles de paginación -->
    <ion-card *ngIf="totalPages > 1" class="dashboards-card pagination-card">
      <ion-card-content class="dashboards-card-content pagination-content">
        <ion-button 
          fill="clear" 
          [disabled]="!hasPreviousPage || loadingMore" 
          (click)="goToPreviousPage()"
          class="pagination-button">
          <ion-icon slot="icon-only" name="chevron-back-outline"></ion-icon>
        </ion-button>
        
        <ion-text class="pagination-info">
          Página {{ currentPage }} de {{ totalPages }}
        </ion-text>
        
        <ion-button 
          fill="clear" 
          [disabled]="!hasNextPage || loadingMore" 
          (click)="goToNextPage()"
          class="pagination-button">
          <ion-icon slot="icon-only" name="chevron-forward-outline"></ion-icon>
        </ion-button>
      </ion-card-content>
    </ion-card>
  </ng-container>
</ion-content>